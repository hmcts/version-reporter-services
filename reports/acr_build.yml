parameters:
  spACR: ''
  prImage: false
  buildContext: ''
  containerACRRepo: ''
  majorMinorVersion: ''
  patchVersion: ''
  ${{ if eq(variables['isMain'], true) }}:
    containerTag: "${{ variables.majorMinorVersion }}.$(patchVersion)"
  ${{ if and(eq(variables['prImage'], true), eq(variables['Build.Reason'], 'PullRequest'), eq(variables['isMain'], false) ) }}:
    containerTag: "pr-$(System.PullRequest.PullRequestNumber)"
  ${{ if and(eq(variables['prImage'], true), ne(variables['Build.Reason'], 'PullRequest'), eq(variables['isMain'], false) ) }}:
    containerTag: "pr-$(Build.BuildID)"

steps:
  - task: Docker@2
    displayName: Login to ACR
    condition: |
      or(
        and(succeeded(),
          eq(variables.isMain, true),
          or(eq(variables['isAutoTriggered'], true))),
        and(succeeded(),
          eq(variables.isMain, false),
          eq('${{ parameters.prImage }}', true),
          eq(variables['Build.Reason'], 'Manual'))
      )
    inputs:
      command: login
      containerRegistry: ${{ parameters.spACR }}

  - task: Docker@2
    displayName: Build Container
    condition: |
      or(
        and(succeeded(),
          eq(variables['isMain'], true),
          or(eq(variables['isAutoTriggered'], true))
        ),
        and(succeeded(),
          eq(variables['isMain'], false),
          eq(parameters['prImage']', true),
          eq(variables['Build.Reason'], 'Manual')
        ))
    inputs:
      command: buildAndPush
      containerRegistry: ${{ parameters.spACR }}
      repository: ${{ parameters.containerACRRepo }}
      buildContext: ${{ parameters.buildContext }}
      tags: |
        ${{ parameters.containerTag }}