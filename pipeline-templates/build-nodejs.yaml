# Build output will be a container image pushed to ARC on merged to master
# Branches will only test code, install necessary libraries etc
# This would be a base template for NodeJS related reports

parameters:
  prImage: ""
  workingDirectory: ""

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: "18.x"
    displayName: "Install Node.js"

  - task: Bash@3
    displayName: "Install tsc"
    inputs:
      targetType: "inline"
      workingDirectory: ${{ parameters.workingDirectory }}
      script: |
        yarn
        
        FILE=${{ parameters.workingDirectory }}/bin
        if [ ! -f "$FILE" ]; then
          yarn tsc --init --rootDir src --outDir ./bin --esModuleInterop --lib ES2019 --module commonjs --noImplicitAny true
        fi

  - task: Bash@3
    displayName: "Run application unit Tests"
    inputs:
      targetType: "inline"
      workingDirectory: ${{ parameters.workingDirectory }}
      script: |
        yarn test

  - task: Bash@3
    displayName: "Build application resource"
    condition: |
      or( 
         and(succeeded(), eq(variables['isMain'], true)),
         and(succeeded(), eq('${{ parameters.prImage }}', true))
       )
    inputs:
      targetType: "inline"
      workingDirectory: ${{ parameters.workingDirectory }}
      script: |
        yarn build
